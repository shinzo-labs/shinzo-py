name: On Push to Main Branch

on:
  push:
    branches:
      - main

concurrency:
  group: deployment
  cancel-in-progress: true

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.version-check.outputs.changed }}
      current_version: ${{ steps.version-check.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if version changed
        id: version-check
        run: |
          current_version=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          base_version=$(git show HEAD^:pyproject.toml | grep -E '^version = ' | sed 's/version = "\(.*\)"/\1/')

          echo "current_version=$current_version" >> $GITHUB_OUTPUT

          if [ "$current_version" != "$base_version" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed from $base_version to $current_version"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $current_version"
          fi

  check-bump-needed:
    runs-on: ubuntu-latest
    outputs:
      bumpNeeded: ${{ steps.bump-check.outputs.bumpNeeded }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install commitizen
        run: |
          python -m pip install --upgrade pip
          pip install commitizen

      - name: Check if version bump is needed
        id: bump-check
        run: |
          # Get commits since last tag
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$last_tag" ]; then
            echo "No previous tags found, bump needed"
            echo "bumpNeeded=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are any commits that would trigger a bump
          commits_since_tag=$(git log $last_tag..HEAD --oneline)

          if [ -z "$commits_since_tag" ]; then
            echo "No new commits since last tag"
            echo "bumpNeeded=false" >> $GITHUB_OUTPUT
          else
            echo "New commits found since last tag, bump needed"
            echo "bumpNeeded=true" >> $GITHUB_OUTPUT
          fi

  create-release-pr:
    name: Create or update Release PR
    runs-on: ubuntu-latest
    needs: [check-version, check-bump-needed]
    if: needs.check-bump-needed.outputs.bumpNeeded == 'true' && needs.check-version.outputs.version_changed == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install commitizen
        run: |
          python -m pip install --upgrade pip
          pip install commitizen

      - name: Configure git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Check for existing release branch
        id: check-branch
        run: |
          git fetch origin
          if git ls-remote --heads origin | grep -q 'refs/heads/release/automated'; then
            echo "exists=true" >> $GITHUB_OUTPUT
            git checkout release/automated
            git pull origin release/automated
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            git checkout -b release/automated
          fi

      - name: Bump version and update changelog
        id: bump
        run: |
          # Dry run to get the next version
          next_version=$(cz bump --dry-run --yes 2>&1 | grep -oP 'tag to create: v\K[0-9]+\.[0-9]+\.[0-9]+' || echo "")

          if [ -z "$next_version" ]; then
            echo "No version bump needed or error occurred"
            exit 1
          fi

          echo "next_version=$next_version" >> $GITHUB_OUTPUT
          echo "Next version will be: $next_version"

          # Perform the actual bump
          cz bump --yes --changelog

      - name: Push release branch
        run: |
          git push origin release/automated --force

      - name: Create or update Release PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          next_version="${{ steps.bump.outputs.next_version }}"

          # Check if PR already exists
          existing_pr=$(gh pr list --head release/automated --base main --json number --jq '.[0].number' || echo "")

          # Get changelog content
          changelog_content=$(cat CHANGELOG.md | sed -n '/^## /,/^## /p' | head -n -1)

          if [ -n "$existing_pr" ]; then
            echo "Updating existing PR #$existing_pr"
            gh pr edit $existing_pr \
              --title "Release v$next_version" \
              --body "This PR was automatically generated by commitizen.

          ## Changes

          ${changelog_content}

          Merging this PR will:
          - Update the version to $next_version
          - Publish the package to PyPI
          - Create a GitHub release with tag v$next_version"
          else
            echo "Creating new PR"
            gh pr create \
              --title "Release v$next_version" \
              --body "This PR was automatically generated by commitizen.

          ## Changes

          ${changelog_content}

          Merging this PR will:
          - Update the version to $next_version
          - Publish the package to PyPI
          - Create a GitHub release with tag v$next_version" \
              --base main \
              --head release/automated
          fi

  publish-to-pypi:
    name: Publish to PyPI and create GitHub release
    runs-on: ubuntu-latest
    needs: [check-version]
    if: needs.check-version.outputs.version_changed == 'true'
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Get release version and body
        id: get-release-info
        run: |
          version="${{ needs.check-version.outputs.current_version }}"
          echo "version=$version" >> $GITHUB_OUTPUT

          # Try to get PR body from the merged release PR
          pr_body=$(gh pr list --search "$(git rev-parse HEAD)" --state merged --json number,body --jq '.[0].body // ""')

          if [ -n "$pr_body" ]; then
            # Extract the changelog section if it exists
            changelog=$(echo "$pr_body" | sed -n '/# Releases/,/---/p' || echo "$pr_body")
            echo "$changelog" > release_body.tmp
          else
            echo "Release version $version" > release_body.tmp
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get-release-info.outputs.version }}
          name: Release v${{ steps.get-release-info.outputs.version }}
          body_path: release_body.tmp
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
